# Referral System - HERBONE GROW

## Overview
The GROW game features a **referral code system** where existing players can invite new players. When someone uses a referral code:
- The new player gains access to the game
- The referrer earns **2% of all BUD** generated by players they referred
- Codes can be used multiple times (not single-use)

## Authentication Flow
1. **Invite Code Entry**: 5-character referral code validation
2. **Registration**: Username + Solana wallet address
3. **Referral Tracking**: System tracks who referred whom
4. **Passive Earnings**: Referrers earn 2% of their referrals' BUD generation forever

## Setup Instructions

### 1. Create Supabase Tables
Run the SQL script in your Supabase SQL Editor:
```bash
CREATE_INVITE_CODES_TABLE.sql
```

This will:
- Create `invite_codes` table with referral tracking
- Add `wallet_address`, `referral_code`, `referred_by` columns to `players` table
- Insert 10 sample codes (owned by 'SYSTEM')
- Set up Row Level Security policies

### 2. Create Your Own Referral Codes
```sql
-- Create referral codes for specific users
INSERT INTO invite_codes (code, owner_username) VALUES
    ('YOUR5', 'your_username');

-- Check existing codes
SELECT code, owner_username, times_used, total_referral_earnings 
FROM invite_codes 
ORDER BY times_used DESC;
```

## How Referral Earnings Work

### Earning Mechanism
- **When**: Every second that referred players generate BUD
- **Amount**: 2% of the BUD they generate
- **Tracking**: Automatically calculated and distributed
- **Accumulation**: Added to referrer's total_bud and accumulated_bud

### Example
```
Player "Alice" creates referral code "ALICE"
Player "Bob" signs up using code "ALICE"
Bob's plants generate 1000 BUD/minute

Result:
- Bob earns: 1000 BUD/minute
- Alice earns: 20 BUD/minute (2% of 1000)
```

### Multiple Referrals
```
Alice has 10 referred players, each generating 1000 BUD/min

Alice's referral earnings:
10 players × 1000 BUD/min × 2% = 200 BUD/min passive income
```

## Features

### For New Players
- Enter any valid 5-character referral code
- Code can be used by multiple people
- Choose unique username (3-20 characters)
- Link Solana wallet address
- Start playing immediately

### For Referrers
- Earn 2% of all BUD generated by referrals
- Earnings are automatic and passive
- Track total earnings in `invite_codes` table
- See how many times your code was used

### Auto-Focus & UX
- Auto-advance between code input boxes
- Paste support (auto-fills all 5 boxes)
- Backspace navigation
- Enter key submission
- Mobile responsive design

## Files Modified

### New Files
- `js/authSystem.js` - Complete authentication logic
- `CREATE_INVITE_CODES_TABLE.sql` - Database setup

### Updated Files
- `index.html` - Added auth overlay HTML
- `css/style.css` - Auth overlay styling + game container hiding
- `js/main.js` - Integrated auth system with player loading

## Database Schema

### invite_codes Table
```sql
code                      TEXT PRIMARY KEY
owner_username            TEXT NOT NULL
times_used                INTEGER DEFAULT 0
total_referral_earnings   NUMERIC DEFAULT 0
created_at                TIMESTAMP DEFAULT NOW()
```

**Purpose**: Track referral codes and earnings
- `owner_username`: Who owns/created the code
- `times_used`: How many players used this code
- `total_referral_earnings`: Cumulative BUD earned from referrals

### players Table (updated)
```sql
id              TEXT PRIMARY KEY (username, not UUID)
wallet_address  TEXT
referral_code   TEXT (which code they used)
referred_by     TEXT (username of referrer)
total_bud       NUMERIC
accumulated_bud NUMERIC
last_active     TIMESTAMP
```

**Referral Tracking**:
- `referral_code`: The code the player entered (e.g., "ALICE")
- `referred_by`: The owner of that code (e.g., "alice_username")

## User Experience

### Invite Code Screen
- 5 single-character input boxes
- Auto-focus next box on input
- Paste support (auto-fills all boxes)
- Backspace navigation
- Enter key to submit
- "WANT TO GET CODE?" button (links to invite request page)
- **Validation**: Checks if code exists (doesn't check if "used")

### Registration Screen
- Username field (3-20 characters, unique)
- Wallet address field (Solana format, 32-44 chars)
- Enter key navigation between fields
- Real-time validation
- Error messages for invalid inputs
- **Tracks referrer**: Links new player to code owner

### Visual Design
- Pixel-art retro aesthetic
- Green (#00ff41) theme matching game
- "Press Start 2P" font
- Glow effects and shadows
- Mobile responsive (480px breakpoint)
  - Smaller inputs: 45x45px → 60x60px
  - Compact fonts: 6-8px → 8-12px

## Referral Earnings Technical Details

### When Earnings Are Paid

**1. Real-time Generation** (Every Second)
```javascript
// In plantPlacement.js - generateBUDFromPlants()
// Called every 1 second
totalGenerated = sum of all plants' BUD/second
player earns: totalGenerated
referrer earns: totalGenerated × 0.02
```

**2. Offline/Harvest Claims**
```javascript
// In supabaseClient.js - harvestBUD()
// When player claims offline earnings
claimed = server calculates offline BUD
player receives: claimed
referrer earns: claimed × 0.02
```

### Payout Function
```javascript
// supabaseClient.payReferralEarnings(playerId, budEarned)
1. Check if player has referrer (referred_by field)
2. Skip if referrer is 'SYSTEM'
3. Calculate 2% of budEarned
4. Add to referrer's total_bud and accumulated_bud
5. Update invite_codes.total_referral_earnings
6. Silent fail if error (doesn't interrupt gameplay)
```

### Earning Tracking
```sql
-- See your referral stats
SELECT 
    code,
    times_used as "Total Referrals",
    total_referral_earnings as "Total Earned"
FROM invite_codes 
WHERE owner_username = 'your_username';

-- See who you referred
SELECT id, total_bud 
FROM players 
WHERE referred_by = 'your_username'
ORDER BY total_bud DESC;
```

## Testing

### Sample Referral Codes (from SQL script)
```
All owned by 'SYSTEM' (no real referrer):
HERB1  GROW2  DOPE3  BUDS4  LEAF5
KUSH6  HIGH7  JANE8  WEED9  GANJ0
```

### Create Your Own Test Code
```sql
-- Create a code owned by your test user
INSERT INTO invite_codes (code, owner_username) VALUES
    ('TEST1', 'testuser123');
```

### Test Referral Flow
1. **Create First Player** (The Referrer):
   - Clear localStorage
   - Use any SYSTEM code to register as `testuser123`
   - Create personal code: `TEST1`

2. **Create Second Player** (The Referred):
   - Clear localStorage again
   - Use code `TEST1` to register as `referred_player`
   - Place plants and generate BUD

3. **Verify Earnings**:
   ```sql
   -- Check referred player's BUD
   SELECT id, total_bud FROM players WHERE id = 'referred_player';
   
   -- Check referrer's earnings
   SELECT id, total_bud FROM players WHERE id = 'testuser123';
   -- Should show 2% of referred player's earnings
   
   -- Check referral code stats
   SELECT * FROM invite_codes WHERE code = 'TEST1';
   -- times_used should be 1
   -- total_referral_earnings should show accumulated earnings
   ```

### Verify Database
```sql
-- Check all referral relationships
SELECT 
    p.id as "Player",
    p.referral_code as "Code Used",
    p.referred_by as "Referred By",
    p.total_bud as "Player BUD"
FROM players p
WHERE p.referred_by IS NOT NULL;

-- Check referrer earnings
SELECT 
    i.code,
    i.owner_username as "Owner",
    i.times_used as "Referrals",
    i.total_referral_earnings as "Earned BUD",
    p.total_bud as "Owner Total BUD"
FROM invite_codes i
LEFT JOIN players p ON p.id = i.owner_username
ORDER BY i.total_referral_earnings DESC;
```

## Security Features

1. **Code Validation**: Server-side check against database
2. **Multi-Use Codes**: Codes can be used unlimited times
3. **Username Uniqueness**: Checks before registration
4. **Wallet Format Validation**: Basic length check (32-44 chars)
5. **Row Level Security**: Supabase RLS policies enabled
6. **Referrer Tracking**: Immutable once set (can't change referrer)

## Troubleshooting

### "Invalid referral code" error
- Verify code exists in `invite_codes` table
- Ensure Supabase client initialized
- Check browser console for detailed errors

### "Username already taken" error
- Username must be unique in players table
- Try different username

### Referral earnings not showing
- Check browser console for `payReferralEarnings` logs
- Verify player has `referred_by` field set
- Ensure referrer (owner_username) exists in players table
- Check that referred player is actively generating BUD

### Code owner not receiving earnings
- Verify owner_username in invite_codes matches player id
- Check that referred player's `referred_by` matches owner_username
- Look for errors in console: "Referrer not found"
- Ensure referrer is not 'SYSTEM' (system codes don't pay out)

### Game doesn't load after registration
- Check browser console for errors
- Verify player created in Supabase
- Check localStorage has `herbone_username` and `herbone_wallet`

### Auth overlay won't dismiss
- Check `.game-container` has `authenticated` class
- Verify CSS transition is working
- Try hard refresh (Cmd+Shift+R)

## Future Enhancements

- [ ] Referral dashboard UI (show your referred players)
- [ ] Real-time referral earnings notifications
- [ ] Leaderboard for top referrers
- [ ] Referral milestones and bonuses (e.g., 10 referrals = bonus BUD)
- [ ] Custom referral code creation for verified players
- [ ] Email-based referral invitations
- [ ] Social sharing for referral codes
- [ ] Enhanced wallet validation (actual Solana format check)
- [ ] Account recovery flow
- [ ] Multi-wallet support
- [ ] Referral analytics (earnings over time, active referrals, etc.)

## API Reference

### AuthSystem Class
```javascript
// Initialize (auto-runs on page load)
window.authSystem = new AuthSystem();

// Methods (internal use)
authSystem.validateInviteCode()    // Check code with Supabase (doesn't check is_used)
authSystem.registerUser()          // Create player account with referral tracking
authSystem.hideOverlays()          // Hide auth screens
authSystem.showError(message)      // Display error alert
```

### SupabaseClient Referral Methods
```javascript
// Pay 2% to referrer
await window.supabaseClient.payReferralEarnings(playerId, budEarned);
// Returns: { success: true, referrer: "username", amount: 20 }
// Or: { success: false, reason: "no_referrer" | "too_small" | "error" }
```

### Key Event Handlers
- Auto-focus between code inputs
- Enter key submission
- Paste handling (5-char codes)
- Backspace navigation
- Mobile touch support

## Creating Referral Codes for Players

### Manual Method (SQL)
```sql
-- Create code for a specific player
INSERT INTO invite_codes (code, owner_username) VALUES
    ('ALICE', 'alice_username');
```

### Bulk Creation
```sql
-- Create multiple codes
INSERT INTO invite_codes (code, owner_username) VALUES
    ('ALICE', 'alice_username'),
    ('BOB99', 'bob_user'),
    ('CARL5', 'carl_123');
```

### Auto-Generation (Future Feature)
Could implement a function where verified players can generate their own codes through UI.

## Referral Economics

### Revenue Sharing
- **Player**: Keeps 98% of generated BUD
- **Referrer**: Earns 2% of generated BUD
- **Platform**: No cut from referral system

### Example Earnings
| Referrals | Each Generates | Your Passive Income |
|-----------|---------------|---------------------|
| 1 player  | 1,000 BUD/min | 20 BUD/min         |
| 5 players | 1,000 BUD/min | 100 BUD/min        |
| 10 players| 1,000 BUD/min | 200 BUD/min        |
| 50 players| 1,000 BUD/min | 1,000 BUD/min      |

### Growth Potential
If your referrals also refer others, your network grows exponentially:
- You refer 10 players
- Each refers 5 more = 50 second-level (you don't earn from these)
- Total direct earnings: 10 × 2% only

**Note**: This is single-level referral (not MLM/pyramid). You only earn from direct referrals.

## Notes

- Username becomes player's `id` field (not auto-generated UUID)
- Wallet address stored in `wallet_address` column
- Referral code stored in `referral_code` column
- Referrer username stored in `referred_by` column
- Original wallet authentication still works (legacy support)
- Auth system has highest z-index (10000)
- Game hidden until authentication complete
- Referral earnings paid silently (doesn't interrupt gameplay if fails)
- SYSTEM codes don't generate referral payouts
- Referred_by cannot be changed once set (permanent relationship)
